[{"op": "add", "path": "/systemd/units/-", "value": {"contents": "[Unit]\nDescription=Manage node VIPs with keepalived\nWants=network-online.target\nAfter=network-online.target\nConditionPathExists=!/etc/keepalived/.keepalived.done\n\n[Service]\nWorkingDirectory=/etc/keepalived\nExecStart=/usr/local/bin/keepalived.sh\n\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\n", "enabled": true, "name": "keepalived.service"}}, {"op": "add", "path": "/storage/files/-", "value": {"filesystem": "root", "path": "/usr/local/bin/keepalived.sh", "user": {"name": "root"}, "contents": {"source": "data:text/plain;charset=utf-8;base64,IyEvdXNyL2Jpbi9lbnYgYmFzaApzZXQgLWUKCmZ1bmN0aW9uIGdldF9pZmFjZV9pbl92aXBfc3VibmV0KCkgewogICAgbG9jYWwgdmlwCiAgICBsb2NhbCBuZXRfY2lkcgogICAgbG9jYWwgaWZhY2VfY2lkcnMKCiAgICB2aXA9IiQxIgoKICAgIGlmYWNlX2NpZHJzPSQoaXAgYWRkciBzaG93IHwgZ3JlcCAtdiAic2NvcGUgaG9zdCIgfCBncmVwIC1QbyAnaW5ldCBcS1tcZC5dKy9bXGQuXSsnIHwgeGFyZ3MpCiAgICBuZXRfY2lkcj0kKC91c3IvYmluL2VudiBweXRob24gLSAiJHZpcCIgIiRpZmFjZV9jaWRycyIgPDwgRU9GCmltcG9ydCBzeXMKaW1wb3J0IHNvY2tldAppbXBvcnQgc3RydWN0Cgp2aXAgPSBzeXMuYXJndlsxXQppZmFjZV9jaWRycyA9IHN5cy5hcmd2WzJdLnNwbGl0KCkKdmlwX2ludCA9IHN0cnVjdC51bnBhY2soIiFJIiwgc29ja2V0LmluZXRfYXRvbih2aXApKVswXQoKZm9yIGlmYWNlX2NpZHIgaW4gaWZhY2VfY2lkcnM6CiAgICBpcCwgcHJlZml4ID0gaWZhY2VfY2lkci5zcGxpdCgnLycpCiAgICBpcF9pbnQgPSBzdHJ1Y3QudW5wYWNrKCIhSSIsIHNvY2tldC5pbmV0X2F0b24oaXApKVswXQogICAgcHJlZml4X2ludCA9IGludChwcmVmaXgpCiAgICBtYXNrID0gaW50KCcxJyAqIHByZWZpeF9pbnQgKyAnMCcgKiAoMzIgLSBwcmVmaXhfaW50KSwgMikKICAgIHN1Ym5ldF9pcF9pbnRfbWluID0gaXBfaW50ICYgbWFzawogICAgc3VibmV0X2lwID0gc29ja2V0LmluZXRfbnRvYShzdHJ1Y3QucGFjaygiIUkiLCBzdWJuZXRfaXBfaW50X21pbikpCiAgICBzdWJuZXRfaXBfaW50X21heCA9IHN1Ym5ldF9pcF9pbnRfbWluIHwgaW50KCcxJyAqICgzMiAtIHByZWZpeF9pbnQpLCAyKQogICAgc3VibmV0X2lwX21heCA9IHNvY2tldC5pbmV0X250b2Eoc3RydWN0LnBhY2soIiFJIiwgc3VibmV0X2lwX2ludF9tYXgpKQogICAgc3lzLnN0ZGVyci53cml0ZSgnSXMgJXMgYmV0d2VlbiAlcyBhbmQgJXNcbicgJSAodmlwLCBzdWJuZXRfaXAsIHN1Ym5ldF9pcF9tYXgpKQogICAgaWYgc3VibmV0X2lwX2ludF9taW4gPCB2aXBfaW50IDwgc3VibmV0X2lwX2ludF9tYXg6CiAgICAgICAgc3VibmV0X2lwID0gc29ja2V0LmluZXRfbnRvYShzdHJ1Y3QucGFjaygiIUkiLCBzdWJuZXRfaXBfaW50X21pbikpCiAgICAgICAgcHJpbnQoJyVzLyVzJyAlIChzdWJuZXRfaXAsIHByZWZpeCkpCiAgICAgICAgc3lzLmV4aXQoMCkKc3lzLmV4aXQoMSkKRU9GCikKICAgIGlwIC1vIGFkZHIgc2hvdyB0byAiJG5ldF9jaWRyIiB8IGF3ayAne3ByaW50ICQyfScKfQoKbWtkaXIgLS1wYXJlbnRzIC9ldGMva2VlcGFsaXZlZAoKS0VFUEFMSVZFRF9JTUFHRT1yZWdpc3RyeS5hY2Nlc3MucmVkaGF0LmNvbS9yaG9zcDE0L29wZW5zdGFjay1rZWVwYWxpdmVkOjE0LjAKaWYgISBwb2RtYW4gaW5zcGVjdCAiJEtFRVBBTElWRURfSU1BR0UiICY+L2Rldi9udWxsOyB0aGVuCiAgICBlY2hvICJQdWxsaW5nIHJlbGVhc2UgaW1hZ2UuLi4iCiAgICBwb2RtYW4gcHVsbCAiJEtFRVBBTElWRURfSU1BR0UiCmZpCgpBUElfRE5TPSQoc3VkbyBhd2sgLUZbLzpdICcvYXBpU2VydmVyVVJMLyB7cHJpbnQgJDV9JyAvb3B0L29wZW5zaGlmdC9tYW5pZmVzdHMvY2x1c3Rlci1pbmZyYXN0cnVjdHVyZS0wMi1jb25maWcueW1sKQpleHBvcnQgTUFTVEVSX1ZJUD0kKGRpZyArbm9hbGwgK2Fuc3dlciAiJEFQSV9ETlMiIHwgYXdrICd7cHJpbnQgJE5GfScpCmVudiBJTlRFUkZBQ0U9JChnZXRfaWZhY2VfaW5fdmlwX3N1Ym5ldCAiJE1BU1RFUl9WSVAiKSBlbnZzdWJzdCA8IC9ldGMva2VlcGFsaXZlZC9rZWVwYWxpdmVkLmNvbmYudGVtcGxhdGUgPiAvZXRjL2tlZXBhbGl2ZWQva2VlcGFsaXZlZC5jb25mCgpwb2RtYW4gcnVuIFwKICAgICAgICAtLXJtIFwKICAgICAgICAtLXZvbHVtZSAvZXRjL2tlZXBhbGl2ZWQ6L2V0Yy9rZWVwYWxpdmVkOnogXAogICAgICAgIC0tbmV0d29yaz1ob3N0IFwKICAgICAgICAtLWNhcC1hZGQ9TkVUX0FETUlOIFwKICAgICAgICAiJHtLRUVQQUxJVkVEX0lNQUdFfSIgXAogICAgICAgIC91c3Ivc2Jpbi9rZWVwYWxpdmVkIC1mIC9ldGMva2VlcGFsaXZlZC9rZWVwYWxpdmVkLmNvbmYgLS1kb250LWZvcmsgLUQgLWwgLVAKCiMgV29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL29wZW5jb250YWluZXJzL3J1bmMvcHVsbC8xODA3CnRvdWNoIC9ldGMva2VlcGFsaXZlZC8ua2VlcGFsaXZlZC5kb25lCg==", "verification": {}}, "mode": 365}}, {"op": "add", "path": "/storage/files/-", "value": {"filesystem": "root", "path": "/etc/keepalived/keepalived.conf.template", "user": {"name": "root"}, "contents": {"source": "data:text/plain;charset=utf-8;base64,dnJycF9pbnN0YW5jZSBWSV8xIHsKICAgIHN0YXRlIEJBQ0tVUAogICAgaW50ZXJmYWNlICR7SU5URVJGQUNFfQogICAgdmlydHVhbF9yb3V0ZXJfaWQgNTEKICAgIHByaW9yaXR5IDUwCiAgICBhZHZlcnRfaW50IDEKICAgIGF1dGhlbnRpY2F0aW9uIHsKICAgICAgICBhdXRoX3R5cGUgUEFTUwogICAgICAgIGF1dGhfcGFzcyBjbHVzdGVyX3V1aWRfbWFzdGVyX3ZpcAogICAgfQogICAgdmlydHVhbF9pcGFkZHJlc3MgewogICAgICAgICR7TUFTVEVSX1ZJUH0KICAgIH0KfQo=", "verification": {}}, "mode": 420}}]
